!function(){"use strict";angular.module("ml.document-management",["ml.common","ml.uploader","ui.bootstrap","ml.document-management.tpls","ngSanitize"])}(),function(){"use strict";function e(e,t,n){function r(t,n,r,o){return e.post("/v1/resources/dls-management",o,{params:{"rs:uri":n,"rs:command":t,"rs:annotation":r}})}var o={openDLSModal:function(e){return t.open({animation:!0,templateUrl:"/ml-document-management/templates/dls.modal.html",controller:"DLSModalController",size:"lg",resolve:{config:function(){return e}}}).result},documentVersions:function(t){return e.get("/v1/resources/dls-management",{params:{"rs:command":"list-versions","rs:uri":t}}).then(function(e){return e.data.versions})},documentDiff:function(t,n){return e.get("/v1/resources/dls-management",{params:{"rs:command":"versions-diff","rs:uri":t,"rs:previousUri":n}}).then(function(e){return e.data.diffs})},openDocumentVersionsModal:function(e,t){return o.documentVersions(t).then(function(t){return o.openDLSModal({info:{title:e+": Versions"},type:"versions-list",versions:t,fileName:e})})},editDocumentMetaModal:function(e){var t=e||{};e.metadata||(e.metadata=[]),e.metadata&&!angular.isArray(e.metadata)&&(e.metadata=[e.metadata]);var n=[];return o.openDLSModal({info:{title:(e.fileName||"New File")+": Edit"},type:"edit-doc",item:t,model:{roles:n}})}};return o.setPermissions=function(e,t){return r("set-permissions",e,null,{role:t})},o.archiveDocument=function(t){return e["delete"]("/v1/resources/dls-management",{params:{"rs:uri":t}})},o.checkoutDocument=function(e){return r("checkout",e)},o.checkinDocument=function(e){return r("checkin",e)},o.patchMetadata=function(t){var n='<rapi:patch xmlns:rapi="http://marklogic.com/rest-api" xmlns:prop="http://marklogic.com/xdmp/property" xmlns:document-management="http://marklogic.com/ml-document-management/document-meta"><rapi:replace-insert context="/rapi:metadata/prop:properties" position="last-child" select="document-management:metadata"><document-management:metadata>'+(t.title?"<document-management:title>"+t.title+"</document-management:title>":"")+(t.description?"<document-management:description>"+t.description+"</document-management:description>":"");return angular.forEach(t.metadata,function(e,t){e&&(n+="<document-management:data><document-management:label>"+e.label+"</document-management:label><document-management:value>"+e.value+"</document-management:value></document-management:data>")}),n+="</document-management:metadata></rapi:replace-insert></rapi:patch>",e.patch("/v1/documents",n,{headers:{"Content-Type":"application/xml"},params:{uri:t.document,category:"properties"}})},o.editDocumentModal=function(e){e.document;o.editDocumentMetaModal(e).then(function(t){t&&(t.title||t.description)&&o.patchMetadata(e).then(function(){e.title=t.title,e.description=t.description})})},o}function t(e,t,n,r,o){angular.extend(t,r),t.getVersionsDiff=function(e,n){o.documentDiff(e,n).then(function(e){t.diffs=e})},t.clearVersionsDiff=function(){t.diffs=null},t.sanitize=e.trustAsHtml,t.save=function(){n.close(t.item)},t.cancel=function(){n.dismiss("cancel")}}angular.module("ml.document-management").factory("dlsService",e).controller("DLSModalController",t).filter("verionedFileName",function(){return function(e,t){return e&&t?e.replace(/^(.*)\.([^\.]+)$/,"$1.v"+t+".$2"):e}}),e.$inject=["$http","$uibModal","$q"],t.$inject=["$sce","$scope","$uibModalInstance","config","dlsService"]}(),function(){"use strict";function e(e,t){var n={};return n.getDirectoryContents=function(e){return t.get("/v1/resources/directory-list",{params:{"rs:directory":e}}).then(function(e){return e.data})},n.getFileDetails=function(e){return t.get("/v1/resources/directory-list",{params:{"rs:file":e}}).then(function(e){return e.data})},n.createDirectory=function(e){return t.post("/v1/resources/directory-list",null,{params:{"rs:directory-path":e}})},n}function t(e,t,r,o,i,a,c,u){function m(t){e.getFileDetails(t.document).then(function(e){n.extend(t,e)})}function s(e){e.wrap("<form>").closest("form").get(0).reset(),e.unwrap()}var l=function(o,a,c,l){o.user=i.currentUser()||{},o.model={},o.files=[],o.uploadOptions={uriPrefix:o.subUri||"/",extract:"properties",transform:"dls-management"},o.submitDirectory=function(){var t=o.model.newDirectoryName,n=(o.subUri||"/")+t+"/";e.createDirectory(n).then(function(){o.$createDirectory=!1,o.directories.push({uri:n,name:t}),o.directories.sort(function(e,t){var n=e.name.toUpperCase(),r=t.name.toUpperCase();return n<r?-1:n>r?1:0})})},o.createDirectory=function(){o.$createDirectory=!0},o.closeDirectory=function(e){e.$open=!1},o.openDirectory=function(e){e.$open=!0},a=n.element(a);var d=a.find('input[type="file"]:first');o.uploadFile=function(e){d.click(),e.stopPropagation()},o.$watch(function(){return i.currentUser()},function(e){e&&e.name&&(o.user=i.currentUser())},!0),e.getDirectoryContents(o.subUri).then(function(e){o.directories=e.directories;var t=o.directories%2===0;o.evenFileStart=t&&o.isEven||!(t||o.isEven),o.dirFiles=e.files});var p=a;a.parent(".parent-directory").length&&(p=a.parent(".parent-directory")),a.on("drop",function(e){return r.dropFiles(e,p,o)}).on("dragenter dragleave dragover",function(e){return r.dzHighlight(e,p)}),d.on("change",function(e){r.dropFiles(e,a,o)}),o.$watch(function(){return!!o.files[0]&&o.files[0].done},function(e){if(e){var t=o.files[0].name.replace(/\s+/g,"_");o.files.length=0;var r=null;n.forEach(o.dirFiles,function(e){r||e.name!==t||(r=e)}),r||(r={document:o.subUri+t,fileName:t},o.dirFiles.push(r),o.dirFiles.sort(function(e,t){var n=e.fileName.toUpperCase(),r=t.fileName.toUpperCase();return n<r?-1:n>r?1:0})),u(function(){m(r)},100),s(d)}}),o.model.archiveDocument=function(e){t.archiveDocument(e.document).then(function(){m(e)})},o.model.checkoutDocument=function(e){t.checkoutDocument(e.document).then(function(){m(e)})},o.model.checkinDocument=function(e){t.checkinDocument(e.document).then(function(){m(e)})},o.model.documentVersionsModal=t.openDocumentVersionsModal,o.model.editDocumentModal=t.editDocumentModal};return{restrict:"E",replace:!0,transclude:!0,scope:{subUri:"=",isEven:"=?"},compile:function(e){return o.compile(e,l)},templateUrl:"/ml-document-management/templates/directory-explorer.html"}}var n=window.angular,r=n.module("ml.document-management");r.factory("RecursionHelper",["$compile",function(e){return{compile:function(t,r){n.isFunction(r)&&(r={post:r});var o,i=t.contents().remove();return{pre:r&&r.pre?r.pre:null,post:function(t,n){o||(o=e(i)),o(t,function(e){n.append(e)}),r&&r.post&&r.post.apply(null,arguments)}}}}}]),r.service("directoryExplorerService",e).directive("mlDirectoryExplorer",t),e.$inject=["$rootScope","$http"],t.$injector=["directoryExplorerService","dlsService","mlUploadService","RecursionHelper","userService","$location","$q","$timeout"]}();